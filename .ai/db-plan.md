# MongoDB Database Schema for EduFiszki AI

This document outlines the MongoDB database schema for the EduFiszki AI application.

## 1. Collections (Tables)

### 1.1. `users`
Stores user account information.

| Field           | Type        | Constraints/Notes                                   |
|-----------------|-------------|-----------------------------------------------------|
| `_id`           | `ObjectId`  | Primary Key (MongoDB default)                       |
| `email`         | `String`    | Required, Unique. Used for login.                   |
| `hashedPassword`| `String`    | Required. Hashed using a strong algorithm (e.g., bcrypt). |
| `createdAt`     | `Date`      | Required. Timestamp of user creation.               |

### 1.2. `folders`
Stores user-created folders to organize flashcards.

| Field        | Type        | Constraints/Notes                                                                 |
|--------------|-------------|-----------------------------------------------------------------------------------|
| `_id`        | `ObjectId`  | Primary Key (MongoDB default)                                                     |
| `userId`     | `ObjectId`  | Required. Foreign Key (references `users._id`).                                   |
| `name`       | `String`    | Required. Max length (e.g., 100 chars, app-enforced). Unique per user (see Indexes). |
| `createdAt`  | `Date`      | Required. Timestamp of folder creation.                                           |
| `updatedAt`  | `Date`      | Required. Timestamp of last folder update.                                        |
| `isDeleted`  | `Boolean`   | Required. Default: `false`. For soft deletes.                                     |
| `deletedAt`  | `Date`      | Optional. Timestamp of when the folder was soft-deleted. Null if not deleted.     |

### 1.3. `flashcards`
Stores the flashcard content.

| Field        | Type        | Constraints/Notes                                                                |
|--------------|-------------|----------------------------------------------------------------------------------|
| `_id`        | `ObjectId`  | Primary Key (MongoDB default)                                                    |
| `userId`     | `ObjectId`  | Required. Foreign Key (references `users._id`).                                  |
| `folderId`   | `ObjectId`  | Required. Foreign Key (references `folders._id`). Flashcard must belong to a folder. |
| `front`      | `String`    | Required. Plain text. Max 200 characters (application-enforced).                 |
| `back`       | `String`    | Required. Plain text. Max 500 characters (application-enforced).                 |
| `source`     | `String`    | Required. Enum: `"manual"`, `"ai-full"` (generated by AI, no edits), `"ai-edited"` (generated by AI, then edited by user). |
| `createdAt`  | `Date`      | Required. Timestamp of flashcard creation.                                       |
| `updatedAt`  | `Date`      | Required. Timestamp of last flashcard update.                                    |

### 1.4. `userFlashcardStats`
Stores spaced repetition learning statistics for each flashcard per user.
**Note:** The exact fields depend on the chosen Spaced Repetition (SR) library. Below is a potential structure based on common SR algorithm needs.

| Field             | Type        | Constraints/Notes                                                              |
|-------------------|-------------|--------------------------------------------------------------------------------|
| `_id`             | `ObjectId`  | Primary Key (MongoDB default)                                                  |
| `userId`          | `ObjectId`  | Required. Foreign Key (references `users._id`). Composite unique with `flashcardId`. |
| `flashcardId`     | `ObjectId`  | Required. Foreign Key (references `flashcards._id`). Composite unique with `userId`. |
| `nextReviewDate`  | `Date`      | Date when the flashcard is due for next review.                                |
| `interval`        | `Number`    | Current repetition interval (e.g., in days).                                   |
| `easeFactor`      | `Number`    | Factor representing how easy the card is (e.g., SM-2 algorithm parameter).     |
| `repetitionCount` | `Number`    | Number of times the card has been successfully recalled.                       |
| `lastReviewedAt`  | `Date`      | Timestamp of the last review.                                                  |
| `leitnerBox`      | `Number`    | Optional: For Leitner system based algorithms.                                 |
| `lapses`          | `Number`    | Optional: Number of times the card review failed after initial learning.       |
| `status`          | `String`    | Optional: e.g., "new", "learning", "review", "graduated".                      |
| `history`         | `Array`     | Optional: Array of review events { date, rating, interval, easeFactor }.     |
| `customData`      | `Object`    | Optional: For any other SR library specific data.                              |


## 2. Relacje między Kolekcjami

*   **`users` to `folders`**: One-to-Many (`users._id` -> `folders.userId`). A user can have multiple folders.
*   **`users` to `flashcards`**: One-to-Many (`users._id` -> `flashcards.userId`). A user can have multiple flashcards.
*   **`folders` to `flashcards`**: One-to-Many (`folders._id` -> `flashcards.folderId`). A folder can contain multiple flashcards.
*   **`users` to `userFlashcardStats`**: One-to-Many (`users._id` -> `userFlashcardStats.userId`).
*   **`flashcards` to `userFlashcardStats`**: One-to-One (conceptually, for a given user) (`flashcards._id` -> `userFlashcardStats.flashcardId`). Each flashcard has one stats entry per user engaging with it.

## 3. Indeksy

### 3.1. `users`
*   `{ "email": 1 }`, `{ "unique": true }` (for login and ensuring email uniqueness)

### 3.2. `folders`
*   `{ "userId": 1, "isDeleted": 1 }` (for querying user's active/deleted folders)
*   `{ "userId": 1, "name": 1 }`, `{ "unique": true }`
    *   Note: This enforces that a folder name is unique for a given user across all their folders (active or soft-deleted). Application logic must handle user experience if a user tries to create a new folder with a name that matches an existing soft-deleted folder (e.g., prevent or allow and guide). The session notes mention: "logika aplikacji musi zapewnić, że nowa nazwa nie koliduje z istniejącą aktywną nazwą folderu dla danego użytkownika, nawet jeśli istnieje folder usunięty o tej samej nazwie". If the desired behavior is to allow reuse of names from *soft-deleted* folders while ensuring active folder names are unique, a partial unique index would be: `{ "userId": 1, "name": 1 }, { "unique": true, "partialFilterExpression": { "isDeleted": false } }`. However, the session notes explicitly listed the former index.

### 3.3. `flashcards`
*   `{ "userId": 1, "folderId": 1 }` (for querying flashcards by user and folder)
*   `{ "front": "text", "back": "text" }`, `{ "default_language": "none", "caseSensitive": false }` (for case-insensitive text search on front and back fields)

### 3.4. `userFlashcardStats`
*   `{ "userId": 1, "flashcardId": 1 }`, `{ "unique": true }` (ensures one stats entry per flashcard per user)
*   `{ "userId": 1, "nextReviewDate": 1 }` (for efficiently querying flashcards due for review for a user)

## 4. Zasady MongoDB (Row-Level Security)

Row-Level Security (RLS) will be implemented at the application layer (backend - NestJS). All database queries that read or modify user-specific data (in `folders`, `flashcards`, `userFlashcardStats`) must be filtered by `userId` based on the authenticated user. This ensures that users can only access and manipulate their own data.

## 5. Wszelkie dodatkowe uwagi lub wyjaśnienia dotyczące decyzji projektowych

*   **Timestampy**: `createdAt` and `updatedAt` fields are consistently used across collections to track record creation and modification times.
*   **Soft Deletes**: Folders use a soft-delete pattern (`isDeleted: true`, `deletedAt: <timestamp>`). Flashcards in a soft-deleted folder are not explicitly marked but become inaccessible through application logic that filters by active folders.
*   **Kandydaci na Fiszki (AI)**: AI-generated "candidates" for flashcards are not stored in the database. Only user-accepted (and potentially edited) flashcards are saved. The `source` field in the `flashcards` collection indicates if a flashcard originated from AI and whether it was edited.
*   **Wymagany Folder dla Fiszki**: Application logic must ensure that every flashcard is assigned to a `folderId` upon creation. There is no default folder, and flashcards cannot exist without a folder.
*   **Limity Danych**:
    *   Długość pól `front` (200 znaków) i `back` (500 znaków) w fiszkach jest walidowana na poziomie aplikacji.
    *   Nie ma limitów co do liczby fiszek na folder ani łącznej liczby fiszek na użytkownika dla MVP.
*   **Wybór Biblioteki Spaced Repetition**: The structure of the `userFlashcardStats` collection is contingent upon the selection of an open-source Spaced Repetition library. The provided fields are common but should be finalized post-library selection.
*   **Unikalność Nazw Folderów**: The chosen index `{ "userId": 1, "name": 1 }` with `unique: true` for the `folders` collection makes folder names unique per user, regardless of the `isDeleted` status. If a user soft-deletes a folder named "Math" and wants to create a new folder named "Math", this index will prevent it unless the soft-deleted folder's name is altered or it's physically deleted. Application logic should guide the user in such scenarios or a partial unique index (as noted in section 3.2) should be considered if name reuse of deleted folders is a strict requirement. 